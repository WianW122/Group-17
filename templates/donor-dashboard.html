<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donor Dashboard â€“ Play It Forward</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";
    const user = JSON.parse(localStorage.getItem("user") || "{}");

    if (!user || !user.user_id) {
      window.location.href = "/login";
    }
  </script>

  <style>
    body { background-color: #fff; }
    h2, h4 { font-weight: 600; }
    .card { border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,.1); }
    .btn-orange { background:#ff7f00; color:#fff; border:none; }
    .btn-orange:hover { background:#e67300; }
    .btn-outline-orange { color:#ff7f00; border-color:#ff7f00; }
    .btn-outline-orange:hover { color:#fff; background:#ff7f00; }
    .table thead { background:#ff7f00; color:#fff; }
    .text-orange { color:#ff7f00; }
  </style>
</head>

<body>
  <div class="container py-5">
    <h2 class="text-center mb-4">Donor Dashboard</h2>
    <p class="lead text-center mb-5">Log new donations, view pickup schedules, and track your contribution impact.</p>

    <!-- SIGN OUT BUTTON -->
    <div class="d-flex justify-content-end mb-4">
      <button id="logoutBtn" class="btn btn-outline-orange">Sign Out</button>
    </div>

    <script>
      document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.removeItem('user');
        sessionStorage.removeItem('user');
        window.location.href = '/';
      });
    </script>

    <!-- === METRICS SECTION === -->
    <section class="mb-5">
      <h4 class="mb-3">Your Donation Metrics</h4>
      <div class="card p-4 text-center" style="max-width: 400px; margin:auto;">
        <h5>Total Donations Made</h5>
        <p id="totalDonations" class="fs-3 fw-bold text-orange">0</p>
      </div>
    </section>

    <!-- === LOG NEW DONATION === -->
    <section class="mb-5">
      <h4 class="mb-3">Log New Donation</h4>
      <div class="card p-4 mx-auto" style="max-width: 500px;">
        <div id="donationAlert"></div>
        <form id="donationForm">
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input id="item_name" required class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input id="item_quantity" type="number" required class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Condition</label>
            <select id="item_condition" required class="form-select">
              <option value="">Select</option>
              <option value="new">New</option>
              <option value="used">Used</option>
            </select>
          </div>

          <button class="btn btn-orange w-100 mb-2">Submit Donation</button>
          <a href="/schedule-pickup" class="btn btn-outline-orange w-100 mb-2">Schedule Pickup</a>
          <a href="/" class="btn btn-outline-orange w-100">Back to Home</a>
        </form>
      </div>
    </section>

    <!-- === PICKUP SCHEDULE TABLE === -->
    <section class="mb-5">
      <h4 class="mb-3">Pickup Schedule</h4>
      <div class="card p-4">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>Address</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="pickupTable"></tbody>
        </table>
      </div>
    </section>

    <!-- === IMPACT REPORTS === -->
    <section>
      <h4 class="mb-3">Impact Reports from NPOs</h4>
      <div class="card p-4">
        <ul class="list-group list-group-flush" id="impactList"></ul>
      </div>
    </section>
  </div>

  <script>
    // ------------------------------
    // UTILITY: REFRESH DASHBOARD
    // ------------------------------
    async function refreshDashboard() {
      await Promise.all([
        loadTotalDonations(),
        loadPickups(),
        loadImpactReports()
      ]);
    }

    // ------------------------------
    // LOAD TOTAL DONATIONS
    // ------------------------------
    async function loadTotalDonations() {
      try {
        const res = await fetch(`${API_BASE}/donations/total/${user.user_id}`);
        const data = await res.json();
        document.getElementById("totalDonations").innerText = data.total_donations || 0;
      } catch {
        document.getElementById("totalDonations").innerText = "0";
      }
    }

    // ------------------------------
    // LOAD PICKUPS
    // ------------------------------
    async function loadPickups() {
      try {
        const res = await fetch(`${API_BASE}/pickups/${user.user_id}`);
        const data = await res.json();

        const tbody = document.getElementById("pickupTable");
        tbody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-center">No pickups scheduled yet.</td></tr>`;
          return;
        }

        data.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td>${p.scheduled_date}</td>
              <td>${p.pickup_address}</td>
              <td>${p.status}</td>
            </tr>
          `;
        });
      } catch {
        document.getElementById("pickupTable").innerHTML = `<tr><td colspan="3" class="text-center">Unable to load pickups.</td></tr>`;
      }
    }

    // ------------------------------
    // LOAD IMPACT REPORTS
    // ------------------------------
    async function loadImpactReports() {
      try {
        const res = await fetch(`${API_BASE}/impact-reports`);
        const reports = await res.json();

        const list = document.getElementById("impactList");
        list.innerHTML = "";

        if (!Array.isArray(reports) || reports.length === 0) {
          list.innerHTML = `<li class="list-group-item text-center">No impact reports available yet.</li>`;
          return;
        }

        reports.forEach(r => {
          list.innerHTML += `
            <li class="list-group-item">
              <strong>${r.npo_name}:</strong> Received ${r.item_quantity} ${r.item_name}. 
              "${r.comments}"
            </li>
          `;
        });
      } catch {
        document.getElementById("impactList").innerHTML = `<li class="list-group-item text-center">Unable to load impact reports.</li>`;
      }
    }

    // ------------------------------
    // SUBMIT DONATION
    // ------------------------------
    document.getElementById("donationForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const alertBox = document.getElementById("donationAlert");
      alertBox.innerHTML = "";

      const item_name = document.getElementById("item_name").value;
      const item_quantity = document.getElementById("item_quantity").value;
      const item_condition = document.getElementById("item_condition").value;

      try {
        // 1. Create donation
        const donationRes = await fetch(`${API_BASE}/donations`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            donor_store_id: user.user_id,
            donation_amount: 0,
            donation_type: "item",
            notes: "Item donation"
          })
        });
        const donation = await donationRes.json();

        // 2. Add donation items
        await fetch(`${API_BASE}/donations/items`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            donation_id: donation.donation_id,
            item_name,
            item_quantity,
            item_description: item_condition
          })
        });

        // 3. Show success alert
        alertBox.innerHTML = `<div class="alert alert-success">Donation logged successfully!</div>`;
        document.getElementById("donationForm").reset();

        // 4. Refresh entire dashboard dynamically
        await refreshDashboard();

      } catch (err) {
        console.error(err);
        alertBox.innerHTML = `<div class="alert alert-danger">Failed to log donation. Please try again.</div>`;
      }
    });

    // INITIAL LOAD
    refreshDashboard();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
