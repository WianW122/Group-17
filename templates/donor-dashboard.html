<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donor Dashboard â€“ Play It Forward</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";
    const user = JSON.parse(localStorage.getItem("user") || "{}");

    if (!user || !user.user_id) {
      window.location.href = "/login";
    }
  </script>

  <style>
    body { background-color: #fff; }
    h2, h4 { font-weight: 600; }
    .card { border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,.1); }
    .btn-orange { background:#ff7f00; color:#fff; border:none; }
    .btn-orange:hover { background:#e67300; }
    .btn-outline-orange { color:#ff7f00; border-color:#ff7f00; }
    .btn-outline-orange:hover { color:#fff; background:#ff7f00; }
    .table thead { background:#ff7f00; color:#fff; }
  </style>
</head>

<body>
  <div class="container py-5">
    <h2 class="text-center mb-4">Donor Dashboard</h2>
    <p class="lead text-center mb-5">Log new donations, view pickup schedules, and track impact reports.</p>

    <div class="d-flex justify-content-end mb-3">
  <button id="logoutBtn" class="btn btn-outline-orange">Sign Out</button>
</div>

<script>
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn?.addEventListener('click', () => {
    // Clear logged-in user info
    localStorage.removeItem('user');
    sessionStorage.removeItem('user');
    // Redirect to home page
    window.location.href = '/';
  });
</script>


    <!-- Log New Donation -->
    <section class="mb-5">
      <h4 class="mb-3">Log New Donation</h4>
      <div class="card p-4 mx-auto" style="max-width: 500px;">
        <form id="donationForm">
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input id="item_name" required class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input id="item_quantity" type="number" required class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Condition</label>
            <select id="item_condition" required class="form-select">
              <option value="">Select</option>
              <option value="new">New</option>
              <option value="used">Used</option>
            </select>
          </div>

          <button class="btn btn-orange w-100 mb-2">Submit Donation</button>
          <a href="/schedule-pickup" class="btn btn-outline-orange w-100 mb-2">Schedule Pickup</a>
          <a href="/" class="btn btn-outline-orange w-100">Back to Home</a>
        </form>
      </div>
    </section>

    <!-- Pickup Schedules -->
    <section class="mb-5">
      <h4 class="mb-3">Pickup Schedule</h4>
      <div class="card p-4">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>Address</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="pickupTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Impact Reports -->
    <section>
      <h4 class="mb-3">Impact Reports from NPOs</h4>
      <div class="card p-4">
        <ul class="list-group list-group-flush" id="impactList"></ul>
      </div>
    </section>

  </div>

  <script>
    // ------------------------------
    // LOAD PICKUPS
    // ------------------------------
    async function loadPickups() {
      const res = await fetch(`${API_BASE}/pickups/${user.user_id}`);
      const data = await res.json();

      const tbody = document.getElementById("pickupTable");
      tbody.innerHTML = "";

      data.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.scheduled_date}</td>
            <td>${p.pickup_address}</td>
            <td>${p.status}</td>
          </tr>
        `;
      });
    }

    // ------------------------------
    // LOAD IMPACT REPORTS
    // ------------------------------
    async function loadImpactReports() {
      const res = await fetch(`${API_BASE}/impact-reports`);
      const reports = await res.json();

      const list = document.getElementById("impactList");
      list.innerHTML = "";

      reports.forEach(r => {
        list.innerHTML += `
          <li class="list-group-item">
            <strong>${r.npo_name}:</strong> Received ${r.item_quantity} ${r.item_name}. 
            "${r.comments}"
          </li>
        `;
      });
    }

    // ------------------------------
    // SUBMIT DONATION
    // ------------------------------
    document.getElementById("donationForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const donationRes = await fetch(`${API_BASE}/donations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          donor_store_id: user.user_id,
          donation_amount: 0,
          donation_type: "item",
          notes: "Item donation"
        })
      });

      const donation = await donationRes.json();

      await fetch(`${API_BASE}/donations/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          donation_id: donation.donation_id,
          item_name: item_name.value,
          item_quantity: item_quantity.value,
          item_description: item_condition.value
        })
      });

      alert("Donation logged successfully!");
      document.getElementById("donationForm").reset();
    });

    // INITIAL LOAD
    loadPickups();
    loadImpactReports();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
