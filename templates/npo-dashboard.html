<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NPO Dashboard – Play It Forward</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <script>
      const API_BASE = "http://127.0.0.1:5000/api";  
  </script>
  
  <style>
    body { background-color: #fff; }
    h2, h4 { font-weight: 600; }
    .card { border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .btn-orange { background-color: #ff7f00; color: #fff; border: none; transition: background-color 0.2s; }
    .btn-orange:hover { background-color: #e67300; }
    .btn-outline-orange { color: #ff7f00; border-color: #ff7f00; background-color: transparent; transition: all 0.2s; }
    .btn-outline-orange:hover { color: #fff; background-color: #ff7f00; border-color: #ff7f00; }
    .form-control:focus, .form-select:focus, textarea:focus { border-color: #ff7f00; box-shadow: 0 0 0 0.2rem rgba(255,127,0,0.25); }
    a { color: #ff7f00; text-decoration: none; transition: color 0.2s; }
    a:hover { color: #e67300; text-decoration: underline; }
    .table thead { background-color: #ff7f00; color: #fff; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center text-dark mb-4">NPO Dashboard</h2>
    <p class="lead text-center mb-5">Request equipment, track deliveries, and submit feedback on received donations.</p>

    <!-- Request Equipment -->
    <section class="mb-5">
      <h4 class="mb-3">Request Equipment</h4>
      <div class="card p-4 mx-auto" style="max-width: 500px;">
        <div id="requestAlert"></div>
        <form id="requestForm">
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input id="itemName" type="text" class="form-control" placeholder="e.g. Basketball" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input id="itemQty" type="number" class="form-control" placeholder="Enter quantity" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Urgency Level</label>
            <select id="itemUrgency" class="form-select" required>
              <option value="">Select</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <button type="submit" class="btn btn-orange w-100 mb-2">Submit Request</button>
          <a href="index.html" class="btn btn-outline-orange w-100">Back to Home</a>
        </form>
      </div>
    </section>

    <!-- Track Deliveries -->
    <section class="mb-5">
      <h4 class="mb-3">Delivery Tracking</h4>
      <div class="card p-4 shadow-sm">
        <table class="table table-bordered mb-0" id="deliveriesTable">
          <thead>
            <tr>
              <th>Delivery ID</th>
              <th>Item</th>
              <th>Quantity</th>
              <th>Status</th>
              <th>Expected Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated dynamically -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Submit Feedback -->
    <section>
      <h4 class="mb-3">Submit Feedback</h4>
      <div class="card p-4 mx-auto" style="max-width: 500px;">
        <div id="feedbackAlert"></div>
        <form id="feedbackForm">
          <div class="mb-3">
            <label class="form-label">Delivery ID</label>
            <input id="feedbackDeliveryId" type="text" class="form-control" placeholder="Enter delivery ID" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Rating (1–5)</label>
            <input id="feedbackRating" type="number" min="1" max="5" class="form-control" placeholder="Rate 1–5" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Comments</label>
            <textarea id="feedbackComments" class="form-control" rows="3" placeholder="Enter your comments" required></textarea>
          </div>
          <button type="submit" class="btn btn-orange w-100 mb-2">Submit Feedback</button>
          <a href="index.html" class="btn btn-outline-orange w-100">Back to Home</a>
        </form>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));

    // Load deliveries dynamically
    async function loadDeliveries() {
      const tableBody = document.querySelector("#deliveriesTable tbody");
      tableBody.innerHTML = "";
      try {
        const res = await fetch(`${API_BASE}/deliveries?npo_id=${user.user_id}`);
        const deliveries = await res.json();
        deliveries.forEach(d => {
          tableBody.innerHTML += `
            <tr>
              <td>${d.id}</td>
              <td>${d.item_name}</td>
              <td>${d.quantity}</td>
              <td>${d.status}</td>
              <td>${d.expected_date}</td>
            </tr>
          `;
        });
      } catch(err) {
        tableBody.innerHTML = `<tr><td colspan="5">Unable to load deliveries</td></tr>`;
      }
    }

    loadDeliveries();

    // Submit Request
    document.getElementById("requestForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        npo_id: user.user_id,
        item_name: document.getElementById("itemName").value,
        quantity: document.getElementById("itemQty").value,
        urgency: document.getElementById("itemUrgency").value
      };
      const res = await fetch(`${API_BASE}/request-equipment`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const result = await res.json();
      const alertBox = document.getElementById("requestAlert");
      if(res.ok) {
        alertBox.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        document.getElementById("requestForm").reset();
        loadDeliveries();
      } else {
        alertBox.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
      }
    });

    // Submit Feedback
    document.getElementById("feedbackForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        npo_id: user.user_id,
        delivery_id: document.getElementById("feedbackDeliveryId").value,
        rating: document.getElementById("feedbackRating").value,
        comments: document.getElementById("feedbackComments").value
      };
      const res = await fetch(`${API_BASE}/submit-feedback`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const result = await res.json();
      const alertBox = document.getElementById("feedbackAlert");
      if(res.ok) {
        alertBox.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        document.getElementById("feedbackForm").reset();
      } else {
        alertBox.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
      }
    });
  </script>
</body>
</html>
